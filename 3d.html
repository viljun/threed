<style>
    .svg_icon {
        stroke:         black;
        fill:           transparent;
        border:         1px solid lightgray;
        width:          800px;
        height:         800px;
        stroke-width:   0.01;
        stroke-linecap: round;
    }
    #debug {
        float:right;
        width:35%;
    }
</style>

<div id='debug'>
    Use arrow keys + shift / alt.
    <br>
    <br>
    <table>
        <tr><td>angle_change           </td><td>                    </td><td><span id='angle_change'           ></span></td></tr>
        <tr><td>movement_change        </td><td>                    </td><td><span id='movement_change'        ></span></td></tr>
        <tr><td>extra_angle_x          </td><td>                    </td><td><span id='extra_angle_x'          ></span></td></tr>
        <tr><td>extra_angle_y          </td><td>                    </td><td><span id='extra_angle_y'          ></span></td></tr>
        <tr><td>extra_angle_z          </td><td>                    </td><td><span id='extra_angle_z'          ></span></td></tr>
        <tr><td>angle_increase_x       </td><td>                    </td><td><span id='angle_increase_x'       ></span></td></tr>
        <tr><td>angle_increase_y       </td><td>left / right + alt                    </td><td><span id='angle_increase_y'       ></span></td></tr>
        <tr><td>angle_increase_z       </td><td>up / down + alt                    </td><td><span id='angle_increase_z'       ></span></td></tr>
        <tr><td>viewer_increase_x      </td><td>                    </td><td><span id='viewer_increase_x'      ></span></td></tr>
        <tr><td>viewer_increase_y      </td><td>                    </td><td><span id='viewer_increase_y'      ></span></td></tr>
        <tr><td>viewer_increase_z      </td><td>up / down + shift   </td><td><span id='viewer_increase_z'      ></span></td></tr>
        <tr><td>viewer_angle_increase_x</td><td>up / down           </td><td><span id='viewer_angle_increase_x'></span></td></tr>
        <tr><td>viewer_angle_increase_y</td><td>left / right + shift</td><td><span id='viewer_angle_increase_y'></span></td></tr>
        <tr><td>viewer_angle_increase_z</td><td>left / right        </td><td><span id='viewer_angle_increase_z'></span></td></tr>
        <tr><td>printable_text         </td><td>                    </td><td><span id='printable_text'         ></span></td></tr>
        <tr><td>letters                </td><td>                    </td><td><span id='letters'                ></span></td></tr>
        <tr><td>angle_x                </td><td>                    </td><td><span id='angle_x'                ></span></td></tr>
        <tr><td>angle_y                </td><td>                    </td><td><span id='angle_y'                ></span></td></tr>
        <tr><td>angle_z                </td><td>                    </td><td><span id='angle_z'                ></span></td></tr>
        <tr><td>viewer_angle_x         </td><td>                    </td><td><span id='viewer_angle_x'         ></span></td></tr>
        <tr><td>viewer_angle_y         </td><td>                    </td><td><span id='viewer_angle_y'         ></span></td></tr>
        <tr><td>viewer_angle_z         </td><td>                    </td><td><span id='viewer_angle_z'         ></span></td></tr>
        <tr><td>viewer_x               </td><td>                    </td><td><span id='viewer_x'               ></span></td></tr>
        <tr><td>viewer_y               </td><td>                    </td><td><span id='viewer_y'               ></span></td></tr>
        <tr><td>viewer_z               </td><td>                    </td><td><span id='viewer_z'               ></span></td></tr>
    </table>
</div>

<svg id="svg_entity" class="svg_icon" viewBox="-2 -2 4 4" xmlns="http://www.w3.org/2000/svg"></svg>

<script>
    var angle_change            = 0.002;
    var movement_change         = 0.1;
    var extra_angle_x           = 0.0;
    var extra_angle_y           = 0.0;
    var extra_angle_z           = 0.0;
    var angle_increase_x        = 0.0;
    var angle_increase_y        = 0.0;
    var angle_increase_z        = 0.0;
    var viewer_increase_x       = 0.0;
    var viewer_increase_y       = 0.0;
    var viewer_increase_z       = 0.0;
    var viewer_angle_increase_x = 0.0;
    var viewer_angle_increase_y = 0.0;
    var viewer_angle_increase_z = 0.0;
    var printable_text          = "kalsarit\non\nkivoja";
    var letters;

    // Get text from keyboard.
    document.addEventListener('keydown', function(e) {
        if (window.getLetters().has(e.key)) {
            printable_text += e.key;
            updatePicture3d();
        } else if (e.keyCode === 32) {
            printable_text += " ";
            updatePicture3d();
        } else if (e.keyCode === 13) {
            printable_text += "\n";
            updatePicture3d();
            extra_angle_x += 6.28;
        } else if (e.keyCode === 8) {
            if (printable_text.length > 0) {
                printable_text = printable_text.substring(0, printable_text.length - 1);
                updatePicture3d();
            } else {
                extra_angle_z += 6.28;
            }
        // Arrow right.
        } else if (e.keyCode === 39) {
            if (e.shiftKey === true) {
                viewer_angle_increase_y += angle_change;
            } else if (e.altKey === true) {
                angle_increase_y -= angle_change;
            } else {
                viewer_angle_increase_z += angle_change;  // turn
            }
        // Arrow left.
        } else if (e.keyCode === 37) {
            if (e.shiftKey === true) {
                viewer_angle_increase_y -= angle_change;
            } else if (e.altKey === true) {
                angle_increase_y -= angle_change;
                e.preventDefault();
            } else {
                viewer_angle_increase_z -= angle_change;  // turn
            }
        // Arrow down.
        } else if (e.keyCode === 40) {
            if (e.shiftKey === true) {
                viewer_increase_z -= movement_change;  // thrust
            } else if (e.altKey === true) {
                angle_increase_z += angle_change;
            } else {
                viewer_angle_increase_x += angle_change;  // turn
            }
        // Arrow up.
        } else if (e.keyCode === 38) {
            if (e.shiftKey === true) {
                viewer_increase_z += movement_change;
            } else if (e.altKey === true) {
                angle_increase_z -= angle_change;
            } else if (e.ctrlKey === true) {
                extra_angle_z -= angle_change;
            } else {
                viewer_angle_increase_x -= angle_change;  // turn
            }
        } else {
            extra_angle_y += 6.28;
            console.log('unknown character ' + e.key);
        }

        console.log(e.keyCode);
    });
</script>

<script type="module">
    import { Cube3D } from "./ts/js/Cube3D.js";
    import { Drawing2D } from "./ts/js/Drawing2D.js";
    import { Drawing3D } from "./ts/js/Drawing3D.js";
    import { Letters } from "./ts/js/Letters.js";
    import { Line3D } from "./ts/js/Line3D.js";
    import { Path2D } from "./ts/js/Path2D.js";
    import { Path3D } from "./ts/js/Path3D.js";
    import { Picture2D } from "./ts/js/Picture2D.js";
    import { Picture3D } from "./ts/js/Picture3D.js";
    import { Point2D } from "./ts/js/Point2D.js";
    import { Point3D } from "./ts/js/Point3D.js";
    import { Rotation } from "./ts/js/Rotation.js";
    import { Tests } from "./ts/js/Tests.js";
    import { Text } from "./ts/js/Text.js";

    var angle_x        = 0.0;
    var angle_y        = 0.0;
    var angle_z        = 0.0;
    var viewer_angle_x = 0.0;
    var viewer_angle_y = 0.0;
    var viewer_angle_z = 0.0;
    var viewer_x       = 0;
    var viewer_y       = 0;
    var viewer_z       = -160;
    var origo          = new Point3D(0, 0, 0);

    function refreshSvg() {
        angle_x        += angle_increase_x;
        angle_y        += angle_increase_y;
        angle_z        += angle_increase_z;
        viewer_angle_x += viewer_angle_increase_x;
        viewer_angle_y += viewer_angle_increase_y;
        viewer_angle_z += viewer_angle_increase_z;
        viewer_x       += viewer_increase_x;
        viewer_y       += viewer_increase_y;
        viewer_z       += viewer_increase_z;

        if (extra_angle_x !== 0) {
            const tmp = extra_angle_x / 5;
            angle_x += tmp;
            extra_angle_x -= tmp;
        }

        if (extra_angle_y !== 0) {
            const tmp = extra_angle_y / 5;
            angle_y += tmp;
            extra_angle_y -= tmp;
        }

        if (extra_angle_z !== 0) {
            const tmp = extra_angle_z / 5;
            angle_z += tmp;
            extra_angle_z -= tmp;
        }

        document.getElementById('angle_change'           ).innerHTML = angle_change;
        document.getElementById('movement_change'        ).innerHTML = movement_change;
        document.getElementById('extra_angle_x'          ).innerHTML = extra_angle_x;
        document.getElementById('extra_angle_y'          ).innerHTML = extra_angle_y;
        document.getElementById('extra_angle_z'          ).innerHTML = extra_angle_z;
        document.getElementById('angle_increase_x'       ).innerHTML = angle_increase_x;
        document.getElementById('angle_increase_y'       ).innerHTML = angle_increase_y;
        document.getElementById('angle_increase_z'       ).innerHTML = angle_increase_z;
        document.getElementById('viewer_increase_x'      ).innerHTML = viewer_increase_x;
        document.getElementById('viewer_increase_y'      ).innerHTML = viewer_increase_y;
        document.getElementById('viewer_increase_z'      ).innerHTML = viewer_increase_z;
        document.getElementById('viewer_angle_increase_x').innerHTML = viewer_angle_increase_x;
        document.getElementById('viewer_angle_increase_y').innerHTML = viewer_angle_increase_y;
        document.getElementById('viewer_angle_increase_z').innerHTML = viewer_angle_increase_z;
        document.getElementById('printable_text'         ).innerHTML = printable_text;
        document.getElementById('letters'                ).innerHTML = letters;
        document.getElementById('angle_x'                ).innerHTML = angle_x;
        document.getElementById('angle_y'                ).innerHTML = angle_y;
        document.getElementById('angle_z'                ).innerHTML = angle_z;
        document.getElementById('viewer_angle_x'         ).innerHTML = viewer_angle_x;
        document.getElementById('viewer_angle_y'         ).innerHTML = viewer_angle_y;
        document.getElementById('viewer_angle_z'         ).innerHTML = viewer_angle_z;
        document.getElementById('viewer_x'               ).innerHTML = viewer_x;
        document.getElementById('viewer_y'               ).innerHTML = viewer_y;
        document.getElementById('viewer_z'               ).innerHTML = viewer_z;

        let rotation = new Rotation(
            angle_x,
            angle_y,
            angle_z,
        );
        let viewer_rotation = new Rotation(
            viewer_angle_x,
            viewer_angle_y,
            viewer_angle_z,
        );
        let viewer = new Point3D(
            viewer_x,
            viewer_y,
            viewer_z,
        );

        update(rotation, viewer_rotation, viewer);
    }

    const letters = Letters.getMap();
    window.getLetters = () => {
        return letters;
    }
    const drawings = [
        letters.get("k").move(new Point2D(   0,  50)).toDrawing3D().move(new Point3D(0, 0, 1200)),
        letters.get("a").move(new Point2D( 200,   0)).toDrawing3D().move(new Point3D(0, 0,  800)),
        letters.get("n").move(new Point2D( 400,  50)).toDrawing3D().move(new Point3D(0, 0,  400)),
        letters.get("a").move(new Point2D( 600, 100)).toDrawing3D().move(new Point3D(0, 0,    0)),
    ];
    for (let i = 1; i < 100;i++) {
        const cube_3d = Cube3D.getCube();
        drawings.push(cube_3d.move(new Point3D(
            (Math.random() - 0.5) * 100000 - 100,
            (Math.random() - 0.5) * 100000 - 100,
            (Math.random() - 0.5) * 100000 - 100,
        )));
    }

    window.updatePicture3d = () => {
        const text = new Text(printable_text + "_", letters);
        const tmp_drawings = [];
        drawings.forEach((tmp) => {
            tmp_drawings.push(tmp);
        });
        tmp_drawings.push(text.toDrawing2D().toDrawing3D().move(new Point3D(-800, -800, 4000)));
        picture_3d = new Picture3D(tmp_drawings);
    }

    function update(rotation, viewer_rotation, viewer) {
        let drawings_3d_rotated = [];
        picture_3d.drawings_3d.forEach((drawing_3d) => {
            const center = drawing_3d.center();
            drawings_3d_rotated.push(drawing_3d.rotate(rotation, center));
        });

        let picture_3d_rotated = new Picture3D(drawings_3d_rotated);
        picture_3d_rotated = picture_3d_rotated.rotate(viewer_rotation, viewer);
        // picture_3d_rotated = picture_3d_rotated.rotate(viewer_rotation, origo);

        document.getElementById('svg_entity').innerHTML = picture_3d_rotated.html(viewer);
    }

    let picture_3d;

    updatePicture3d();

    const intervalID = setInterval(refreshSvg, 30);

    Tests.run();
</script>